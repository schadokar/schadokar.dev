<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.62.2" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark">
<script src="https://kit.fontawesome.com/4872e84fa1.js" crossorigin="anonymous"></script><title>Store Hyperledger Fabric certificates and keys in CouchDB&nbsp;&ndash;&nbsp;Shubham Chadokar</title><link rel="stylesheet" href="/css/core.min.d6952daf9b9e1416674c325169c3a71ceb436c5f824d6ee2013146d3b7206ca6152d067fa14aadb42755d718bc2fdd29.css" integrity="sha384-1pUtr5ueFBZnTDJRacOnHOtDbF&#43;CTW7iATFG07cgbKYVLQZ/oUqttCdV1xi8L90p"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Store Hyperledger Fabric certificates and keys in CouchDB" /><meta name="twitter:image" content="https://schadokar.dev/posts/store-hyperledger-fabric-certificates-and-keys-in-couchdb/cover-pic.jpg" /><body><section id="header">
    <div class="header wrap">
        <span class="header left-side">
            <a class="site home" href="/"><span class="site name">Shubham Chadokar</span>
            </a>
        </span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/posts">Posts</a><a class="nav item" href="/to-the-point">To-The-Point</a><a class="nav item" href="/projects">Projects</a><a class="nav item" href="/ebooks">Ebook</a><a class="nav item" href="/about">About</a></nav></div></span>
    </div>
    
</section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Store Hyperledger Fabric certificates and keys in CouchDB</h1><p class="article date">Saturday, February 8, 2020<span class="reading-time"> ‚Ä¢ 5 minutes to read</span></p></section><article class="article markdown-body"><p>
            <img class="cover" src="cover-pic.jpg" alt>
          </p><p>Photo by <a href="https://unsplash.com/@mr_williams_photography?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText"target="_blank">Micah Williams</a> on <a href="https://unsplash.com/s/photos/safe?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText"target="_blank">Unsplash</a></p>
<p>Hyperledger Fabric is all about permissions. These permissions are provided in the form of
certificates and keys. In broad term, it is known as <a href="https://hyperledger-fabric.readthedocs.io/en/latest/identity/identity.html"target="_blank">Identities</a>.</p>
<p>When an application interacts with the Hyperledger Fabric Network, it uses this identity to authenticate itself. Fabric network validates the identity and authorizes the application to interact.</p>
<p>In short, identities are very important and if you don't save them properly, then it may turn into a headache. üò©</p>
<h2 id="where-can-i-store-the-identities-">Where can I store the Identities? üíº</h2>
<p>In Hyperledger Fabric, this storage is known as <a href="https://hyperledger-fabric.readthedocs.io/en/latest/developapps/wallet.html"target="_blank"><strong><em>Wallet</em></strong></a>.</p>
<p>There are three types of wallet:</p>
<ul>
<li>
<h4 id="_file-system_"><em>File System</em></h4>
This is a simple folder. A local storage wallet. It is a good default choice for wallets. In <code>fabric-samples/balance-transfer</code>, the <code>file system</code> is the default wallet. When you run the <code>balance-transfer</code> it creates a <code>fabric-client-kv-orgName</code> folder and saves all the identities in it. This configuration is defined in the <code>orgname.yaml</code> <a href="https://github.com/hyperledger/fabric-samples/blob/release-1.4/balance-transfer/artifacts/org1.yaml"target="_blank">link</a>.</li>
<li>
<h4 id="_in-memory_"><em>In-Memory</em></h4>
A wallet in application storage. Use this type of wallet when your application is running in a constrained environment without access to a file system; typically a web browser. It‚Äôs worth remembering that this type of wallet is volatile; identities will be lost after the application ends normally or crashes. - <a href="https://hyperledger-fabric.readthedocs.io/en/latest/developapps/wallet.html#types"target="_blank">Documentation</a></li>
<li>
<h4 id="_couchdb_"><em>CouchDB</em></h4>
Using couchdb as a wallet. This option is best for production.</li>
</ul>
<hr>
<p>In this tutorial, we will configure the <code>CouchDB</code> as the Wallet. üë®üèª‚Äçüíª</p>
<blockquote>
<p><em>For the demonstration, I am using <code>Fabric Node SDK</code> and <code>fabric/samples/balance-transfer</code>.</em></p>
</blockquote>
<p>The wallet uses 2 stores to save the certificates and keys:</p>
<h4 id="1-state-store">1. State Store:</h4>
<p>The state store is used to store the certificates of the enrolled identity. It stores the basic information of the identity:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;test&#34;</span>,
  <span style="color:#f92672">&#34;mspid&#34;</span>: <span style="color:#e6db74">&#34;org1&#34;</span>,
  <span style="color:#f92672">&#34;roles&#34;</span>: <span style="color:#66d9ef">null</span>,
  <span style="color:#f92672">&#34;affiliation&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
  <span style="color:#f92672">&#34;enrollmentSecret&#34;</span>: <span style="color:#e6db74">&#34;&lt;ENROLLMENT_SECRET&gt;&#34;</span>,
  <span style="color:#f92672">&#34;enrollment&#34;</span>: {
    <span style="color:#f92672">&#34;signingIdentity&#34;</span>: <span style="color:#e6db74">&#34;&lt;PRIVATE_KEY_NAME&gt;&#34;</span>,
    <span style="color:#f92672">&#34;identity&#34;</span>: {
      <span style="color:#f92672">&#34;certificate&#34;</span>: <span style="color:#e6db74">&#34;&lt;SIGN_CERT&gt;&#34;</span>
    }
  }
}
</code></pre></div><blockquote>
<p>‚ùóÔ∏è <em>Note: The signingIdentity is the pointer or the address of the private and public key stored in the crypto-store.</em></p>
</blockquote>
<h4 id="2-crypto-store">2. Crypto Store:</h4>
<p>The crypto store is used to store the public and private key of the identity.</p>
<hr>
<p>To configure the couchdb as wallet:</p>
<h4 id="step-1">Step 1</h4>
<p>Import the <code>CouchDBKeyValueStore</code> library, which is provided by the <code>Node SDK</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">CDBKVS</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;fabric-client/lib/impl/CouchDBKeyValueStore.js&#34;</span>);
</code></pre></div><blockquote>
<p><em>Do read the <a href="https://github.com/hyperledger/fabric-sdk-node/blob/release-1.4/fabric-client/lib/impl/CouchDBKeyValueStore.js"target="_blank"><code>CouchDBKeyValueStore.js</code></a> it is worth reading.</em></p>
</blockquote>
<h4 id="step-2">Step 2</h4>
<p>Set the <code>state store</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stateStore</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">await</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">CDBKVS</span>({
  <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;https://&lt;USERNAME&gt;:&lt;PASSWORD&gt;@&lt;URL&gt;&#34;</span>,
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&lt;DB_NAME&gt;&#34;</span>
});

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">Client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;fabric-client&#34;</span>);

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">loadFromConfig</span>(<span style="color:#e6db74">&#34;path of network.yaml&#34;</span>);

<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">setStateStore</span>(<span style="color:#a6e22e">stateStore</span>);
</code></pre></div><ul>
<li><code>&lt;USERNAME&gt;</code> is the username of the couchdb.</li>
<li><code>&lt;PASSWORD&gt;</code> is the password of the couchdb.</li>
<li><code>&lt;URL&gt;</code> is the couchdb URL.</li>
<li><code>&lt;DB_NAME&gt;</code> (OPTIONAL) is the dbname to use as state store. The default dbname is <code>userdb</code>. It creates the DB if it doesn't exist.</li>
</ul>
<blockquote>
<p><strong><em><a href="https://hyperledger.github.io/fabric-sdk-node/release-1.4/Client.html"target="_blank">Client</a> is the interface between the user and the fabric network.</em></strong></p>
</blockquote>
<h4 id="step-3">Step 3</h4>
<p>Set the <code>crypto store</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cryptoSuite</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">newCryptoSuite</span>();

<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">cryptoKS</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">newCryptoKeyStore</span>(<span style="color:#a6e22e">CDBKVS</span>, {
  <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;https://&lt;USERNAME&gt;:&lt;PASSWORD&gt;@&lt;URL&gt;&#34;</span>,
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&lt;DB_NAME&gt;&#34;</span>
});

<span style="color:#a6e22e">cryptoSuite</span>.<span style="color:#a6e22e">setCryptoKeyStore</span>(<span style="color:#a6e22e">cryptoKS</span>);

<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">setCryptoSuite</span>(<span style="color:#a6e22e">cryptoSuite</span>);
</code></pre></div><p>You have to update the client according to the above steps to make it use the couchdb.<br>
In the next section, we'll implement the above steps in the <code>balance-transfer</code> fabric sample.</p>
<hr>
<h2 id="implementation-of-couchdb-in-balance-transfer">Implementation of CouchDB in Balance Transfer</h2>
<p>I am using the <a href="https://github.com/hyperledger/fabric-samples/blob/release-1.4/balance-transfer"target="_blank">balance transfer</a> fabric sample as a reference.</p>
<blockquote>
<p><em>I am assuming that you know how to run the balance transfer.</em></p>
</blockquote>
<h3 id="start-the-balance-transfer-network">Start the balance transfer network</h3>
<p>Follow the balance transfer instructions to start the network.</p>
<p>It will start the network with:</p>
<ul>
<li>2 CAs</li>
<li>A SOLO Orderer</li>
<li>4 peers (2 peers per Org)</li>
</ul>
<h3 id="start-a-couchdb-for-the-wallet">Start a couchdb for the wallet</h3>
<p>This step is optional if you're using the cloud based couchdb.</p>
<p><strong>Docker-based Couchdb</strong></p>
<pre><code>docker run --name couch-userdb -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -p 5984:5984 -d couchdb
</code></pre><p>Above command will pull the docker image of the <code>couchdb</code> from the docker hub if it doesn't exist.</p>
<h5 id="couchdb-details">CouchDB Details:</h5>
<ul>
<li>Container Name: couch-userdb</li>
<li>CouchDB Username: admin</li>
<li>CouchDB Password: password</li>
<li>URL: localhost:5984</li>
</ul>
<p>The CouchDB connection URL is</p>
<pre><code>https://&lt;USERNAME&gt;:&lt;PASSWORD&gt;@&lt;URL&gt;

https://admin:password@localhost:5984
</code></pre><h3 id="update-the-client-in-the-balance-transfer">Update the client in the balance-transfer</h3>
<p>Open the <code>app/helper.js</code> and update the <code>getClientForOrg</code>.</p>
<p>In the below code, we just replaced <code>await client.initCredentialStores();</code> with the above couchdb config steps.</p>
<script type="application/javascript" src="https://gist.github.com/schadokar/004b87e24a52f7260bd7cad252353cbb.js"></script>

<p>The changes we made,</p>
<ul>
<li><strong><em>Line 13:</em></strong> Import the <code>CouchDBKeyValueStore</code>. Step 1 from above.</li>
<li><strong><em>Line 31-52:</em></strong> Set the state store and crypto store. Step 2 &amp; 3.</li>
</ul>
<p>There is a minor change in the above code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// Client variable is used as hfc
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">hfc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;fabric-client&#34;</span>);

<span style="color:#75715e">// Instead of Client
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">Client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;fabric-client&#34;</span>);
</code></pre></div><p><strong><em>It is not necessary that db(dbname) of state store and crypto store is the same. Both the stores can have their separate dbs. It depends on the requirement. You can have state store and crypto store db as <code>orgName-state-store</code> and <code>orgName-crypto-store</code> respectively.</em></strong></p>
<p><strong><em>Each organization must have their state-store and crypto-store db, else it will throw the Authentication Error.</em></strong></p>
<pre><code>Error: fabric-ca request register failed with errors [[{&quot;code&quot;:20,&quot;message&quot;:&quot;Authentication failure&quot;}]]
</code></pre><h3 id="register-a-new-user-in-the-balance-transfer">Register a new user in the balance transfer</h3>
<p>Once you register a user, you can check the state-store and crypto-store using the couchdb apis.</p>
<h5 id="for-example-register-a-user">For Example: Register a user</h5>
<p>I used the below arguments to register a user. For <code>org1</code>, I used the same db <code>org1db</code> for both <code>state-store</code> and <code>crypto-store</code>.</p>
<ul>
<li>Name: alice</li>
<li>Org: org1</li>
<li>DBNAME: org1db</li>
<li>CouchDB URL: http://admin:password@localhost:5369</li>
</ul>
<p>Open the browser, go to <code>http://localhost:5369/org1db/_all_docs</code>. It returns all the docs saved in the <code>org1db</code>.</p>
<p><img  src="./asset1.PNG"
        alt/></p>
<p>The indexes <code>0, 1, 2</code> are the certificates of the <code>admin</code>.</p>
<p>The index <code>3</code> is the <code>alice</code> certificate stored in the <code>state-store</code>.<br>
The indexes <code>4-5</code> are the <code>alice</code>'s public and private keys stored in the <code>crypto-store</code>.</p>
<p>Go to <code>http://localhost:5369/org1db/alice</code>.
It returns all the details of the <code>alice</code> stored in the state store.</p>
<p><img  src="./asset2.PNG"
        alt/></p>
<p>Check the <code>signingIdentity</code>.</p>
<pre><code>&quot;signingIdentity&quot;:&quot;d37a97a8c2377c21537801ec1a929d81905ae57963a2f6c8ba0308931a7fc791&quot;
</code></pre><p>Now, check the id of the indexes <code>4 &amp; 5</code> in the above image. Both are same.</p>
<p>If you remember, <code>signingIdentity</code> field is a reference of the private and public keys of the identity stored in the crypto store.</p>
<h3 id="conclusion">Conclusion</h3>
<p>CouchDB wallet is a great choice for a production use case. You can try with other dbs but in that case, you have to write the library accordingly like <code>CouchDBKeyValueStore.js</code>.</p>
<hr>
<p>Below are the references I found helpful.<br>
If you find any resource which you think can be added here, don't feel shy to share. üòâ</p>
<hr>
<h2 id="references-">References üìå</h2>
<ul>
<li><a href="https://developer.ibm.com/tutorials/store-fabric-certificates-keys-ibm-cloudant-fabric-node-sdk/">https://developer.ibm.com/tutorials/store-fabric-certificates-keys-ibm-cloudant-fabric-node-sdk/</a></li>
<li><a href="https://stackoverflow.com/questions/53639061/hyperledger-fabric-what-is-the-difference-between-state-store-and-crypto-store">https://stackoverflow.com/questions/53639061/hyperledger-fabric-what-is-the-difference-between-state-store-and-crypto-store</a></li>
<li><a href="https://stackoverflow.com/questions/54305378/hyperledger-fabric-client-credential-store-using-couchdb">https://stackoverflow.com/questions/54305378/hyperledger-fabric-client-credential-store-using-couchdb</a></li>
<li><a href="https://stackoverflow.com/questions/58371858/hyperledger-fabric-client-credential-store-using-couchdbcouchdbkeyvaluestore">https://stackoverflow.com/questions/58371858/hyperledger-fabric-client-credential-store-using-couchdbcouchdbkeyvaluestore</a></li>
</ul>
<hr>
</article><section class="article labels"><a class="category" href=/categories/tutorial/>Tutorial</a><a class="category" href=/categories/blockchain/>Blockchain</a><a class="tag" href=/tags/hyperledger-fabric/>hyperledger-fabric</a><a class="tag" href=/tags/couchdb/>couchdb</a><a class="tag" href=/tags/tutorial/>tutorial</a></section></div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/posts/understand-quicksort-the-easy-way/"><span class="li iconfont icon-article"></span>Understand Quicksort the easy way</a></p><p><a class="link" href="/posts/use-environment-variable-in-your-next-golang-project/"><span class="li iconfont icon-article"></span>Use Environment Variable in your next Golang Project</a></p></section><section class="article discussion"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "schadokar" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section></div></section>
<section id="footer">
    <div class="footer wrap">
        <span class="footer">
                
                    <a href="https://github.com/schadokar" class="navbar-item is-hidden-desktop" title="GitHub">
                        <span
                            class="icon"><i class='fab fa-github'></i>
                        </span>
                    </a>
                
                    <a href="https://medium.com/@schadokar" class="navbar-item is-hidden-desktop" title="Medium">
                        <span
                            class="icon"><i class='fab fa-medium'></i>
                        </span>
                    </a>
                
                    <a href="https://twitter.com/schadokar1" class="navbar-item is-hidden-desktop" title="Twitter">
                        <span
                            class="icon"><i class='fab fa-twitter'></i>
                        </span>
                    </a>
                <div class="footer-wrap">
    <p class="copyright">&copy; <a href="https://schadokar.dev">Shubham Chadokar</a> 2020</p>
    <p class="powerby"><span>Powered by </span><a href="https://gohugo.io" 
        target="_blank">Hugo</a><span> and the </span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank">Notepadium</a></p>
</div></span>
        <span class="footer right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">Categories</a><a class="nav item" href="/tags/">Tags</a><a class="nav item" href="/newsletter">Newsletter</a><a class="nav item" href="/contact">Contact</a></nav></div></span>
    </div>
</section>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-158088106-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</body>

</html>